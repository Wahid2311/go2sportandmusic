{% extends base_template %}
{% load static %}
{% block title %} My Listing {% endblock %}
{% block dashboard_content %}
<link rel="stylesheet" href="{% static 'tickets/css/tickets.css' %}">

<div class="container reseller-listings-container">
  <h2 class="ticket-title text-center mb-4">
    <i class="bi bi-list-check"></i> My Ticket Listings
  </h2>

  {% regroup tickets by event as event_groups %}

  {% for group in event_groups %}
    {% if forloop.counter0|divisibleby:1 %}
      <div class="event-block mb-5">
        <h4 class="event-name">
          {{ group.grouper.name }} 
          <small class="text-muted">
            ({{ group.grouper.date }} {{ group.grouper.time }})
          </small>
        </h4>
        <p class="event-venue"><i class="bi bi-geo-alt"></i> {{ group.grouper.stadium_name }}</p>

        <div class="row g-3">
          {% for ticket in group.list %}
          <div class="col-12">
            <div class="ticket-card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <span class="badge bg-success">{{ ticket.ticket_type }}</span>
                  <strong>#{{ ticket.ticket_id }}</strong>
                </div>
                <div>
                  {% if ticket.sold %}
                    <span class="badge bg-secondary">Sold</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Available</span>
                  {% endif %}
                </div>
              </div>

              <div class="row">
                <div class="col-md-4"><strong>Qty:</strong> {{ ticket.number_of_tickets }}</div>
                <div class="col-md-4"><strong>Section:</strong> {{ ticket.section.name }}</div>
                <div class="col-md-4"><strong>Row:</strong> {{ ticket.row }}</div>
              </div>
              <div class="row mt-2">
                <div class="col-md-4"><strong>Seats:</strong> {{ ticket.seats|join:", " }}</div>
                <div class="col-md-4"><strong>Face Value:</strong> £{{ ticket.face_value }}</div>
                <div class="col-md-4"><strong>Sell Price:</strong> £{{ ticket.sell_price }}</div>
              </div>

              <div class="mt-3 d-flex gap-2">
                <a href="{% url 'events:reseller_update' ticket.ticket_id %}" class="btn btn-sm btn-primary">
                  <i class="bi bi-pencil-square"></i> Edit
                </a>
                <form method="post" action="{% url 'events:reseller_delete' ticket.ticket_id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger"
                          onclick="return confirm('Delete this listing?');">
                    <i class="bi bi-trash3"></i> Delete
                  </button>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% empty %}
  {% endfor %}

  {# Pagination #}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
          &laquo;
        </a>
      </li>
      {% endif %}
      {% for num in page_obj.paginator.page_range %}
      <li class="page-item {% if num == page_obj.number %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
      </li>
      {% endfor %}
      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}">
          &raquo;
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>
{% endblock %}
