{% extends base_template %}
{% load static %}

{% block title %} Create Ticket Listing {% endblock %}

{% block dashboard_content %}

<link rel="stylesheet" href="{% static 'tickets/css/tickets.css' %}">

<div class="container ticket-container">
  <h2 class="ticket-title text-center mb-4">
    <i class="bi bi-ticket-perforated"></i> Create Ticket Listing
  </h2>

  <form method="post" enctype="multipart/form-data" novalidate id="ticketForm">
    {% csrf_token %}

    <div class="row g-4">
      <div class="col-md-6">
        <label class="form-label">{{ form.upload_choice.label }}</label>
        {{ form.upload_choice }}
      </div>

      <div class="col-md-6 conditional-field" data-conditional="upload-choice-now">
        <label class="form-label">{{ form.upload_file.label }}</label>
        {{ form.upload_file }}
      </div>

      <div class="col-md-6 conditional-field" data-conditional="upload-choice-later">
        <label class="form-label">{{ form.upload_by.label }}</label>
        {{ form.upload_by }}
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ form.number_of_tickets.label }}</label>
        {{ form.number_of_tickets }}
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ form.section.label }}</label>
        {{ form.section }}
        <div id="section-prices" class="mt-2">
          <small>Price Range: <span id="price-range">–</span></small>
        </div>
      </div>
      <div class="col-md-6">
        <label class="form-label">{{ form.face_value.label }}</label>
        {{ form.face_value }}
      </div>
      <div class="col-md-6">
        <label class="form-label">{{ form.sell_price.label }}</label>
        {{ form.sell_price }}
        <div id="sell-price-projections" class="mt-2">
          <small>Normal Buyer Pays: £<span id="proj-normal">0.00</span></small><br>
          <small>Reseller Buyer Pays: £<span id="proj-reseller">0.00</span></small>
        </div>
      </div>
      <div class="col-md-6">
        <label class="form-label">{{ form.row.label }}</label>
        {{ form.row }}
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ form.seats.label }}</label>
        {{ form.seats }}
      </div>
      <div class="col-md-6">
        <label class="form-label">{{ form.ticket_type.label }}</label>
        {{ form.ticket_type }}
      </div>

      <div class="col-md-12">
        <label class="form-label">Sell Options</label>
        <div class="d-flex flex-wrap" style="gap: 30px;">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sell_together" id="sell_all_together" value="true" checked>
            <label class="form-check-label" for="sell_all_together">Sell all together</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sell_together" id="sell_pairs_only" value="false">
            <label class="form-check-label" for="sell_pairs_only">Sell only pairs</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sell_together" id="sell_pairs_no_single" value="false">
            <label class="form-check-label" for="sell_pairs_no_single">Sell pairs but not leave any single</label>
          </div>
        </div>
      </div>



      <div class="col-12">
        <h5 class="checkbox-group-title">{{ form.benefits_and_Restrictions.label }}</h5>
        <div class="checkbox-grid restrictions-grid">
          {% for checkbox in form.benefits_and_Restrictions %}
          <div class="form-check">
            {{ checkbox.tag }}
            <label class="form-check-label">{{ checkbox.choice_label }}</label>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="col-12 text-center mt-4">
        <button type="submit" class="btn-ticket-submit">
          List Tickets <i class="bi bi-check-circle"></i>
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const uploadChoice = document.querySelector('[name="upload_choice"]');
    const conditionalFields = document.querySelectorAll('.conditional-field');
    const sectionSelect = document.querySelector('[name="section"]');
    const priceRangeEl = document.getElementById('price-range');
    const sellInput = document.querySelector('[name="sell_price"]');
    const projNormal = document.getElementById('proj-normal');
    const projReseller = document.getElementById('proj-reseller');

    function toggleUploadFields() {
      const val = uploadChoice.value;
      conditionalFields.forEach(el => {
        const shouldShow = el.dataset.conditional === `upload-choice-${val}`;
        el.classList.toggle('active', shouldShow);
        el.style.display = shouldShow ? 'block' : 'none';
      });
    }

    uploadChoice.addEventListener('change', toggleUploadFields);
    toggleUploadFields();

    async function fetchSectionPrices() {
      const id = sectionSelect.value;
      if (!id) {
        priceRangeEl.textContent = '–';
        return;
      }
      try {
        const res = await fetch(`/get-section-prices/?section_id=${id}`);
        const data = await res.json();
        priceRangeEl.textContent = `$${data.lower_price} – $${data.upper_price}`;
      } catch (e) {
        priceRangeEl.textContent = 'Error';
      }
    }
    sectionSelect.addEventListener('change', fetchSectionPrices);
    fetchSectionPrices();


    async function fetchPrices() {
      const url = window.location.pathname;
      const parts = url.split('/');
      event_id = parseInt(parts[2], 10)
      const price = parseFloat(sellInput.value);

      if (isNaN(price)) price = 0;
      projNormal.textContent = '0.00';
      projReseller.textContent = '0.00';
      try {
        const res = await fetch(`/get-event-prices/?event_id=${event_id}`);
        const data = await res.json();
        projNormal.textContent = `${parseInt(price, 10) + (parseInt(data.normal_price, 10) * parseInt(price, 10)) / 100}`;
        projReseller.textContent = `${parseInt(price, 10) + (parseInt(data.reseller_price, 10) * parseInt(price, 10)) / 100}`;
      } catch (e) {
      }
    }
    sellInput.addEventListener('change', fetchPrices);
    fetchPrices();

  });
</script>

{% endblock %}